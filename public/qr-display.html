<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code - Dynamic Display</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: var(--bg-secondary);
    }

    .qr-display-container {
      text-align: center;
      background: var(--bg-primary);
      padding: var(--space-2xl);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      max-width: 600px;
      width: 90%;
    }

    .qr-display-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin-bottom: var(--space-lg);
    }

    .qr-display-subtitle {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-bottom: var(--space-2xl);
    }

    #qr-canvas {
      margin: 0 auto var(--space-xl);
      max-width: 100%;
    }

    .qr-info {
      background: var(--bg-secondary);
      padding: var(--space-lg);
      border-radius: var(--radius-md);
      margin-top: var(--space-xl);
      text-align: left;
    }

    .qr-info-label {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      font-weight: var(--font-medium);
      margin-bottom: var(--space-xs);
    }

    .qr-info-value {
      font-size: var(--text-sm);
      color: var(--text-primary);
      word-break: break-all;
      font-family: monospace;
      background: var(--bg-primary);
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-md);
    }

    .error-message {
      color: var(--error);
      padding: var(--space-lg);
    }
  </style>
</head>
<body>
  <div class="qr-display-container">
    <div id="loading">
      <div class="spinner" style="margin: 0 auto var(--space-md);"></div>
      <p style="color: var(--text-secondary);">Loading QR code...</p>
    </div>

    <div id="qr-content" class="hidden">
      <h1 class="qr-display-title" id="qr-name"></h1>
      <p class="qr-display-subtitle">Scan this QR code to access the content</p>

      <canvas id="qr-canvas"></canvas>

      <div class="qr-info">
        <div class="qr-info-label">Type</div>
        <div class="qr-info-value" id="qr-type"></div>

        <div class="qr-info-label">Content Preview</div>
        <div class="qr-info-value" id="qr-preview"></div>
      </div>
    </div>

    <div id="error-content" class="hidden">
      <div class="error-message">
        <h2>QR Code Not Found</h2>
        <p>This QR code does not exist or has been deleted.</p>
      </div>
    </div>
  </div>

  <!-- QRCode.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/lib/browser.js"></script>

  <script>
    // Get short code from URL path
    const pathParts = window.location.pathname.split('/');
    const shortCode = pathParts[pathParts.length - 1];

    // Fetch QR code data and render
    async function loadAndRenderQR() {
      try {
        // Fetch QR code metadata from API
        const response = await fetch(`/api/qrcodes/by-code/${shortCode}`);

        if (!response.ok) {
          showError();
          return;
        }

        const data = await response.json();

        if (!data.success || !data.qrcode) {
          showError();
          return;
        }

        const qr = data.qrcode;

        // Update page content
        document.getElementById('qr-name').textContent = qr.name || 'QR Code';
        document.getElementById('qr-type').textContent = qr.type.toUpperCase();

        // Show content preview (truncate if too long)
        const preview = (qr.redirect_url || qr.content || '').substring(0, 200);
        document.getElementById('qr-preview').textContent = preview + (preview.length >= 200 ? '...' : '');

        // Generate QR code using client-side library
        const canvas = document.getElementById('qr-canvas');
        await QRCode.toCanvas(canvas, qr.redirect_url || qr.content, {
          width: 400,
          margin: 2,
          color: {
            dark: qr.color_dark || '#000000',
            light: qr.color_light || '#ffffff'
          },
          errorCorrectionLevel: qr.error_correction || 'M'
        });

        // Show content, hide loading
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('qr-content').classList.remove('hidden');

      } catch (error) {
        console.error('Error loading QR code:', error);
        showError();
      }
    }

    function showError() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error-content').classList.remove('hidden');
    }

    // Load on page load
    loadAndRenderQR();
  </script>
</body>
</html>
